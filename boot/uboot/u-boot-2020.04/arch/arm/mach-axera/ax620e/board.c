/*
 * Copyright (c) 2023 AXERA in AX620E project.
 *
 * SPDX-License-Identifier:     GPL-2.0+
 */

#include <common.h>
#include <asm/armv8/mmu.h>
#include <asm/io.h>
#include <malloc.h>
#include <dm.h>
#include <dm/lists.h>
#include <dm/device-internal.h>
#include <dm/uclass-internal.h>
#include <adc.h>
#include <asm/arch/ax620e.h>
#include <asm/arch/boot_mode.h>

#define AX_ADC_BASE		0x2000000
#define AX_ADC_MA_EN		0x2000004
#define AX_ADC_MA_POR_EN	0x2000008
#define AX_ADC_MA_CTRL		0x2000010
#define AX_THM_MA_CTRL		0x200000C
#define AX_ADC_MA_POR_CTRL	0x2000014
#define AX_ADC_CTRL		0x2000018
#define AX_ADC_CLK_EN		0x200001C	/*clk enable */
#define AX_ADC_CLK_SELECT	0x2000020	/*clk select */
#define AX_ADC_RSTN		0x2000024
#define AX_ADC_VREF_EN		0x2000038
#define AX_ADC_MON_EN		0x20000C8
#define AX_ADC_MON_CH		0x20000C4
#define AX_ADC_MON_INTERVAL	0x20000CC

#define AX_ADC_DATA_CHANNEL0	0x20000A0
#define AX_ADC_DATA_CHANNEL1	0x20000A4
#define AX_ADC_DATA_CHANNEL2	0x20000A8
#define AX_ADC_DATA_CHANNEL3	0x20000AC

#define AX_ADC_INT_MASK		0x2000104
#define AX_ADC_SEL(x)		(1 << (10 + x))
#define AX_ADC_SEL_EN		BIT(0)

#define FLASH_SYS_GLB_BASE_ADDR	0x10030000
#define EMAC_FLASH_EPHY_0_ADDR (FLASH_SYS_GLB_BASE_ADDR + 0x20)
#define EMAC_EPHY_LED_POL		13

misc_info_t *misc_info = (misc_info_t *) MISC_INFO_ADDR;
static char *board_name[AX620E_CHIP_MAX][16] = {
	/*AX620Q_CHIP board name*/
	[AX620Q_CHIP][PHY_AX620Q_LP4_EVB_V1_0] = "AX620Q_LP4_EVB_V1_0",
	[AX620Q_CHIP][PHY_AX620Q_LP4_DEMO_V1_0] = "AX620Q_LP4_DEMO_V1_0",
	[AX620Q_CHIP][PHY_AX620Q_LP4_SLT_V1_0] = "AX620Q_LP4_SLT_V1_0",
	[AX620Q_CHIP][PHY_AX620Q_LP4_DEMO_V1_1] = "AX620Q_LP4_DEMO_V1_1",
	[AX620Q_CHIP][PHY_AX620Q_LP4_38BOARD_V1_0] = "AX620Q_LP4_38BOARD_V1_0",
	[AX620Q_CHIP][PHY_AX620Q_LP4_MINION_BOARD] = "AX620Q_LP4_MINION_BOARD",
	/*AX620QX_CHIP board name*/
	[AX620QX_CHIP][PHY_AX620Q_LP4_EVB_V1_0] = "AX620QX_LP4_EVB_V1_0",
	[AX620QX_CHIP][PHY_AX620Q_LP4_DEMO_V1_0] = "AX620QX_LP4_DEMO_V1_0",
	[AX620QX_CHIP][PHY_AX620Q_LP4_SLT_V1_0] = "AX620QX_LP4_SLT_V1_0",
	[AX620QX_CHIP][PHY_AX620Q_LP4_DEMO_V1_1] = "AX620QX_LP4_DEMO_V1_1",
	[AX620QX_CHIP][PHY_AX620Q_LP4_38BOARD_V1_0] = "AX620QX_LP4_38BOARD_V1_0",
	[AX620QX_CHIP][PHY_AX620Q_LP4_MINION_BOARD] = "AX620QX_LP4_MINION_BOARD",
	/*AX630C_CHIP board name*/
	[AX630C_CHIP][PHY_AX630C_EVB_V1_0] = "AX630C_EVB_V1_0",
	[AX630C_CHIP][PHY_AX630C_DEMO_V1_0] = "AX630C_DEMO_V1_0",
	[AX630C_CHIP][PHY_AX630C_DEMO_DDR3_V1_0] = "AX630C_DEMO_DDR3_V1_0",
	[AX630C_CHIP][PHY_AX630C_SLT_V1_0] = "AX630C_SLT_V1_0",
	[AX630C_CHIP][PHY_AX630C_DEMO_V1_1] = "AX630C_DEMO_V1_1",
	[AX630C_CHIP][PHY_AX630C_DEMO_LP4_V1_0] = "AX630C_DEMO_LP4_V1_0",
	// ### SIPEED EDIT ###
	[AX630C_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_0_5G] = "AX630C_MAIXCAM2_SOM_0_5G",
	[AX630C_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_1G] = "AX630C_MAIXCAM2_SOM_1G",
	[AX630C_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_2G] = "AX630C_MAIXCAM2_SOM_2G",
	[AX630C_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_4G] = "AX630C_MAIXCAM2_SOM_4G",
	// ### SIPEED EDIT END ###
	/*AX631_CHIP board name*/
	[AX631_CHIP][PHY_AX630C_EVB_V1_0] = "AX631_EVB_V1_0",
	[AX631_CHIP][PHY_AX630C_DEMO_V1_0] = "AX631_DEMO_V1_0",
	[AX631_CHIP][PHY_AX630C_SLT_V1_0] = "AX631_SLT_V1_0",
	[AX631_CHIP][PHY_AX630C_DEMO_V1_1] = "AX631_DEMO_V1_1",
	[AX631_CHIP][PHY_AX630C_DEMO_LP4_V1_0] = "AX631_DEMO_LP4_V1_0",
	// ### SIPEED EDIT ###
	[AX631_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_0_5G] = "AX631_MAIXCAM2_SOM_0_5G",
	[AX631_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_1G] = "AX631_MAIXCAM2_SOM_1G",
	[AX631_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_2G] = "AX631_MAIXCAM2_SOM_2G",
	[AX631_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_4G] = "AX631_MAIXCAM2_SOM_1G",
	// ### SIPEED EDIT END ###
	/*AX620QZ_CHIP board name*/
	[AX620QZ_CHIP][PHY_AX620Q_LP4_EVB_V1_0] = "AX620QZ_LP4_EVB_V1_0",
	[AX620QZ_CHIP][PHY_AX620Q_LP4_DEMO_V1_0] = "AX620QZ_LP4_DEMO_V1_0",
	[AX620QZ_CHIP][PHY_AX620Q_LP4_SLT_V1_0] = "AX620QZ_LP4_SLT_V1_0",
	[AX620QZ_CHIP][PHY_AX620Q_LP4_DEMO_V1_1] = "AX620QZ_LP4_DEMO_V1_1",
	[AX620QZ_CHIP][PHY_AX620Q_LP4_38BOARD_V1_0] = "AX620QZ_LP4_38BOARD_V1_0",
	[AX620QZ_CHIP][PHY_AX620Q_LP4_MINION_BOARD] = "AX620QZ_LP4_MINION_BOARD",
	/*AX620QP_CHIP board name*/
	[AX620QP_CHIP][PHY_AX620Q_LP4_EVB_V1_0] = "AX620QP_LP4_EVB_V1_0",
	[AX620QP_CHIP][PHY_AX620Q_LP4_DEMO_V1_0] = "AX620QP_LP4_DEMO_V1_0",
	[AX620QP_CHIP][PHY_AX620Q_LP4_SLT_V1_0] = "AX620QP_LP4_SLT_V1_0",
	[AX620QP_CHIP][PHY_AX620Q_LP4_DEMO_V1_1] = "AX620QP_LP4_DEMO_V1_1",
	[AX620QP_CHIP][PHY_AX620Q_LP4_38BOARD_V1_0] = "AX620QP_LP4_38BOARD_V1_0",
	[AX620QP_CHIP][PHY_AX620Q_LP4_MINION_BOARD] = "AX620QP_LP4_MINION_BOARD",
};

static unsigned char ax_board_id[AX620E_CHIP_MAX][16] = {
	/*AX620Q_CHIP board id*/
	[AX620Q_CHIP][PHY_AX620Q_LP4_EVB_V1_0] = AX620Q_LP4_EVB_V1_0,
	[AX620Q_CHIP][PHY_AX620Q_LP4_DEMO_V1_0] = AX620Q_LP4_DEMO_V1_0,
	[AX620Q_CHIP][PHY_AX620Q_LP4_SLT_V1_0] = AX620Q_LP4_SLT_V1_0,
	[AX620Q_CHIP][PHY_AX620Q_LP4_DEMO_V1_1] = AX620Q_LP4_DEMO_V1_1,
	[AX620Q_CHIP][PHY_AX620Q_LP4_38BOARD_V1_0] = AX620Q_LP4_38BOARD_V1_0,
	[AX620Q_CHIP][PHY_AX620Q_LP4_MINION_BOARD] = AX620Q_LP4_MINION_BOARD,
	/*AX620QX_CHIP board id*/
	[AX620QX_CHIP][PHY_AX620Q_LP4_EVB_V1_0] = AX620Q_LP4_EVB_V1_0,
	[AX620QX_CHIP][PHY_AX620Q_LP4_DEMO_V1_0] = AX620Q_LP4_DEMO_V1_0,
	[AX620QX_CHIP][PHY_AX620Q_LP4_SLT_V1_0] = AX620Q_LP4_SLT_V1_0,
	[AX620QX_CHIP][PHY_AX620Q_LP4_DEMO_V1_1] = AX620Q_LP4_DEMO_V1_1,
	[AX620QX_CHIP][PHY_AX620Q_LP4_38BOARD_V1_0] = AX620Q_LP4_38BOARD_V1_0,
	[AX620QX_CHIP][PHY_AX620Q_LP4_MINION_BOARD] = AX620Q_LP4_MINION_BOARD,
	/*AX630C_CHIP board id*/
	[AX630C_CHIP][PHY_AX630C_EVB_V1_0] = AX630C_EVB_V1_0,
	[AX630C_CHIP][PHY_AX630C_DEMO_V1_0] = AX630C_DEMO_V1_0,
	[AX630C_CHIP][PHY_AX630C_DEMO_DDR3_V1_0] = AX630C_DEMO_DDR3_V1_0,
	[AX630C_CHIP][PHY_AX630C_SLT_V1_0] = AX630C_SLT_V1_0,
	[AX630C_CHIP][PHY_AX630C_DEMO_V1_1] = AX630C_DEMO_V1_1,
	[AX630C_CHIP][PHY_AX630C_DEMO_LP4_V1_0] = AX630C_DEMO_LP4_V1_0,
	// ### SIPEED EDIT ###
	[AX630C_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_0_5G] = AX630C_AX631_MAIXCAM2_SOM_0_5G,
	[AX630C_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_1G] = AX630C_AX631_MAIXCAM2_SOM_1G,
	[AX630C_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_2G] = AX630C_AX631_MAIXCAM2_SOM_2G,
	[AX630C_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_4G] = AX630C_AX631_MAIXCAM2_SOM_4G,
	// ### SIPEED EDIT END ###
	/*AX631_CHIP board id*/
	[AX631_CHIP][PHY_AX630C_EVB_V1_0] = AX630C_EVB_V1_0,
	[AX631_CHIP][PHY_AX630C_DEMO_V1_0] = AX630C_DEMO_V1_0,
	[AX631_CHIP][PHY_AX630C_SLT_V1_0] = AX630C_SLT_V1_0,
	[AX631_CHIP][PHY_AX630C_DEMO_V1_1] = AX630C_DEMO_V1_1,
	[AX631_CHIP][PHY_AX630C_DEMO_LP4_V1_0] = AX630C_DEMO_LP4_V1_0,
	// ### SIPEED EDIT ###
	[AX631_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_0_5G] = AX630C_AX631_MAIXCAM2_SOM_0_5G,
	[AX631_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_1G] = AX630C_AX631_MAIXCAM2_SOM_1G,
	[AX631_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_2G] = AX630C_AX631_MAIXCAM2_SOM_2G,
	[AX631_CHIP][PHY_AX630C_AX631_MAIXCAM2_SOM_4G] = AX630C_AX631_MAIXCAM2_SOM_4G,
	// ### SIPEED EDIT END ###
	/*AX620QZ_CHIP board id*/
	[AX620QZ_CHIP][PHY_AX620Q_LP4_EVB_V1_0] = AX620Q_LP4_EVB_V1_0,
	[AX620QZ_CHIP][PHY_AX620Q_LP4_DEMO_V1_0] = AX620Q_LP4_DEMO_V1_0,
	[AX620QZ_CHIP][PHY_AX620Q_LP4_SLT_V1_0] = AX620Q_LP4_SLT_V1_0,
	[AX620QZ_CHIP][PHY_AX620Q_LP4_DEMO_V1_1] = AX620Q_LP4_DEMO_V1_1,
	[AX620QZ_CHIP][PHY_AX620Q_LP4_38BOARD_V1_0] = AX620Q_LP4_38BOARD_V1_0,
	[AX620QZ_CHIP][PHY_AX620Q_LP4_MINION_BOARD] = AX620Q_LP4_MINION_BOARD,
	/*AX620QP_CHIP board id*/
	[AX620QP_CHIP][PHY_AX620Q_LP4_EVB_V1_0] = AX620Q_LP4_EVB_V1_0,
	[AX620QP_CHIP][PHY_AX620Q_LP4_DEMO_V1_0] = AX620Q_LP4_DEMO_V1_0,
	[AX620QP_CHIP][PHY_AX620Q_LP4_SLT_V1_0] = AX620Q_LP4_SLT_V1_0,
	[AX620QP_CHIP][PHY_AX620Q_LP4_DEMO_V1_1] = AX620Q_LP4_DEMO_V1_1,
	[AX620QP_CHIP][PHY_AX620Q_LP4_38BOARD_V1_0] = AX620Q_LP4_38BOARD_V1_0,
	[AX620QP_CHIP][PHY_AX620Q_LP4_MINION_BOARD] = AX620Q_LP4_MINION_BOARD,
};
static const char * chip_type[AX620E_CHIP_MAX] = {
	[AX620Q_CHIP] = "AX620Q_CHIP",
	[AX620QX_CHIP] = "AX620QX_CHIP",
	[AX630C_CHIP] = "AX630C_CHIP",
	[AX631_CHIP] = "AX631_CHIP",
	[AX620QZ_CHIP] = "AX620QZ_CHIP",
	[AX620QP_CHIP] = "AX620QP_CHIP",
};

int ax_adc_calibrate_config(void)
{
	u32 value;
	if(misc_info->thm_vref  == 0) {
		misc_info->thm_vref = 0x7;
	}
	writel(0x0, AX_ADC_RSTN);

	writel(0, AX_ADC_INT_MASK);
	writel(0x1, AX_THM_MA_CTRL);
	writel(0x1, AX_ADC_BASE);
	value = (misc_info->thm_vref << 5) | 0x18;
	writel(0, AX_ADC_CTRL);
	writel(value, AX_ADC_CTRL);
	writel(0x1, AX_ADC_CLK_EN);
	writel(0x1, AX_ADC_RSTN);
	writel((1 << 14), AX_ADC_VREF_EN);

	return 0;
}

int adc_read_boardid(int channel, unsigned int *data)
{
	ax_adc_calibrate_config();
	writel(0x3c00, AX_ADC_MON_CH);
	writel(0x1, AX_ADC_MON_EN);
	udelay(100);

	switch (channel) {
	case 0:
		*data = readl(AX_ADC_DATA_CHANNEL0);
		break;
	case 1:
		*data = readl(AX_ADC_DATA_CHANNEL1);
		break;
	case 2:
		*data = readl(AX_ADC_DATA_CHANNEL2);
		break;
	}
	return 0;

}

int get_board_id(void)
{
	unsigned int cal_val;
	cal_val =  ax_board_id[misc_info->chip_type][misc_info->phy_board_id];
	return cal_val;
}

void print_chip_type(void)
{
	printf("Current chip type: %s\n",chip_type[misc_info->chip_type]);
}

void print_board_id(void)
{
	printf("Current board type: %s\n",board_name[misc_info->chip_type][misc_info->phy_board_id]);
}

void set_ephy_led_pol(void)
{
	u32 value;

	value = readl(EMAC_FLASH_EPHY_0_ADDR);
	// ### SIPEED EDIT ###
	//ephy led pol
	if (misc_info->board_id == PHY_AX630C_AX631_MAIXCAM2_SOM_0_5G ||
		misc_info->board_id == PHY_AX630C_AX631_MAIXCAM2_SOM_1G ||
		misc_info->board_id == PHY_AX630C_AX631_MAIXCAM2_SOM_2G ||
		misc_info->board_id == PHY_AX630C_AX631_MAIXCAM2_SOM_4G ||
		misc_info->board_id == AX630C_DEMO_LP4_V1_0 ||
		misc_info->board_id == AX630C_DEMO_V1_1 ||
		misc_info->board_id == AX620Q_LP4_DEMO_V1_1
	) {
		value |= (0x1 << EMAC_EPHY_LED_POL); //1'b1 low  active
	}
	// ### SIPEED EDIT END ###
	writel(value, EMAC_FLASH_EPHY_0_ADDR);
}
